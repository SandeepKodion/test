!function(r,d,a){r(function(){r("#sst-certificates");var e=r("#sst-certificates tbody"),t=a.template("sst-certificate-row"),o=a.template("sst-certificate-row-blank"),i=Backbone.Model.extend({certificates:{},selected:""}),n=new(Backbone.View.extend({rowTemplate:t,initialize:function(){this.listenTo(this.model,"change:certificates",this.render),r(document.body).on("click",".sst-certificate-add",{view:this},this.onAddCertificate),r(document.body).on("wc_backbone_modal_response",this.onAddCertificateSubmitted)},render:function(){var e=_.indexBy(this.model.get("certificates"),"CertificateID"),t=this.model.get("selected"),i=this,a=1;if(this.$el.empty(),_.size(e))if(r.each(e,function(e,t){t.Index=a++,i.$el.append(i.rowTemplate(t))}),i.$el.find(".sst-certificate-delete").on("click",{view:this},this.onDeleteRow),i.$el.find(".sst-certificate-view").on("click",{view:this},this.onViewCertificate),i.$el.find('input[name="certificate_id"]').on("change",this.updateCheckout),t)r('input[name="certificate_id"][value="'+t+'"]').prop("checked",!0);else{var c=r('input[name="certificate_id"]').first();c&&(c.prop("checked",!0),this.model.set("selected",c.val()))}else i.$el.append(o)},block:function(){r(this.el).block({message:null,overlayCSS:{background:"#fff",opacity:.6}})},unblock:function(){r(this.el).unblock()},updateCheckout:function(e){r(document.body).trigger("update_checkout")},onDeleteRow:function(e){var i=e.data.view,t=i.model,a=(_.indexBy(t.get("certificates"),"CertificateID"),i.model.get("selected")),c=r(this).closest("tr").data("id");e.preventDefault(),confirm(d.strings.delete_certificate)&&(i.block(),r.post(d.ajaxurl+"?action=sst_delete_certificate",{nonce:d.delete_certificate_nonce,certificate_id:c},function(e,t){i.unblock(),"success"===t&&e.success?(a==c&&n.model.set("selected",""),n.model.set("certificates",e.data.certificates),n.model.trigger("change:certificates"),n.updateCheckout()):alert(d.strings.delete_failed+": "+e.data)},"json"))},onViewCertificate:function(e){var t=e.data.view.model,i=_.indexBy(t.get("certificates"),"CertificateID")[r(this).closest("tr").data("id")];e.preventDefault(),i&&(i.SinglePurchase?i.backgroundImage=d.images.single_cert:i.backgroundImage=d.images.blanket_cert,r(this).SSTBackboneModal({template:"sst-modal-view-certificate",variable:i}))},onAddCertificate:function(e){var t=e.data.view;e.preventDefault(),r(this).SSTBackboneModal({template:"sst-modal-add-certificate",variable:{CertificateID:"new-"+(new Date).getTime()},callback:t.validateAddCertificate})},validateAddCertificate:function(e,t,i){var a=r(e.target).closest(".wc-backbone-modal").find("form");return a.find(".validate-required").removeClass("woocommerce-invalid-required-field woocommerce-invalid"),a.find(".validate-required").each(function(){""===r(this).find("input, select, textarea").val()&&r(this).addClass("woocommerce-invalid-required-field woocommerce-invalid")}),0===a.find(".woocommerce-invalid").length},onAddCertificateSubmitted:function(e,t,i){"sst-modal-add-certificate"===t&&(n.block(),r.post(d.ajaxurl+"?action=sst_add_certificate",{nonce:d.add_certificate_nonce,certificate:i,form_data:r("form.woocommerce-checkout").serialize()},function(e,t){n.unblock(),"success"===t&&e.success?(n.model.set("selected",e.data.certificate_id),n.model.set("certificates",e.data.certificates),n.model.trigger("change:certificates"),n.updateCheckout()):alert(d.strings.add_failed+": "+e.data)},"json"))}}))({model:new i({certificates:d.certificates,selected:d.selected}),el:e});n.render(),r(document).on("change","#tax_exempt_checkbox",function(){r("#tax_exempt_checkbox").is(":checked")?r("#tax_details").fadeIn():r("#tax_details").hide(),r(document.body).trigger("update_checkout")}),r(document).on("change","#PurchaserBusinessType",function(){var e=r("#business-type-other_field");"Other"==r(this).val()?e.addClass("validate-required").show():e.removeClass("validate-required").hide()}),r(document).on("change","#TaxType",function(){var e=r("#issuing-state_field");"StateIssued"==r(this).val()?e.addClass("validate-required").show():e.removeClass("validate-required").hide()}),r(document).on("change","#PurchaserExemptionReason",function(){var e=r("#exempt-other-reason_field"),t=e.find("label"),i=r(this).val();if(""!==i){e.addClass("validate-required").show();t.text({FederalGovernmentDepartment:"Dept. Name",StateOrLocalGovernmentName:"Govt. Name",TribalGovernmentName:"Tribe Name",ForeignDiplomat:"Diplomat ID",CharitableOrganization:"Organization ID",ReligiousOrEducationalOrganization:"Organization ID",Resale:"Resale ID",AgriculturalProduction:"Agricultural Prod. ID",IndustrialProductionOrManufacturing:"Production ID",DirectPayPermit:"Permit ID",DirectMail:"Direct Mail ID",Other:"Please explain"}[i])}else e.removeClass("validate-required").hide()}),r(document).on("input",".sst-input",function(e){r(this).closest(".form-row").removeClass("woocommerce-invalid woocommerce-invalid-required-field woocommerce-invalid-email woocommerce-validated")}),r("#tax_exempt_checkbox").change()})}(jQuery,SSTCertData,wp);